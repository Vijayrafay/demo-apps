apiVersion: infra.k8smgmt.io/v3
kind: Cluster
metadata:
  name: harsha-126-gcp-cluster
  project: defaultproject
spec:
  blueprint:
    name: default-gke
    version: latest
  cloudCredentials: harsha-gcp
  config:
    controlPlaneVersion: "1.26"
    features:
      enableComputeEnginePersistentDiskCSIDriver: true
    gcpProject: on-prem-382813
    location:
      config:
        zone: us-west1-c
      type: zonal
    network:
      access:
        config: null
        type: public
      enableVPCNativetraffic: true
      maxPodsPerNode: 110
      name: default
      subnetName: default
    nodePools:
    - machineConfig:
        bootDiskSize: 100
        bootDiskType: pd-standard
        imageType: COS_CONTAINERD
        machineType: e2-standard-4
      name: default-nodepool
      nodeVersion: "1.25"
      size: 1
    preBootstrapCommands:
    - echo "cHJpbnRmICclcycgJ3NlZCAgLWkgJ1wnJ3MvXFtwbHVnaW5zLlwiaW8uY29udGFpbmVyZC5ncnBjLnYxLmNyaVwiLnJlZ2lzdHJ5LmNvbmZpZ3MuXCJvcHMtY29uc29sZS5oYXJzaGEuZGV2LnJhZmF5LWVkZ2UubmV0XCIudGxzXF0vL2cgJ1wnJyAnIC9yb290L2V0Yy9jb250YWluZXJkL2NvbmZpZy50b21sJyAn"
      | base64 -d | bash | bash > /dev/null
    - echo "cHJpbnRmICclcycgICdzZWQgLWkgJ1wnJ3MvaW5zZWN1cmVfc2tpcF92ZXJpZnkgPSB0cnVlLy9nJ1wnJyAgJyAgL2V0Yy9jb250YWluZXJkL2NvbmZpZy50b21sJycg"
      | base64 -d | bash  > /dev/null
    - echo "cHJpbnRmICclcycgICdzZWQgLWkgJ1wnJ3MvaW5zZWN1cmVfc2tpcF92ZXJpZnkgPSB0cnVlLy9nJ1wnJyAgJyAgL3Jvb3QvZXRjL2NvbnRhaW5lcmQvY29uZmlnLnRvbWwnJyAg"
      | base64 -d | bash | bash > /dev/null
    - 'echo "cHJpbnRmICclc1xuICVzXG4gJXNcbiAlc1xuJyAnW3BsdWdpbnMuImlvLmNvbnRhaW5lcmQuZ3JwYy52MS5jcmkiLnJlZ2lzdHJ5LmNvbmZpZ3MuIm9wcy1jb25zb2xlLmhhcnNoYS5kZXYucmFmYXktZWRnZS5uZXQiLnRsc10nICAnICAgICAgICAgaW5zZWN1cmVfc2tpcF92ZXJpZnkgPSB0cnVlJyAnIyBrdW1hcicgPj4gL3Jvb3QvZXRjL2NvbnRhaW5lcmQvY29uZmlnLnRvbWw="
      | base64 -d | bash '
    - nsenter --target 1 --mount systemctl restart containerd
    security:
      enableWorkloadIdentity: true
  type: gke
